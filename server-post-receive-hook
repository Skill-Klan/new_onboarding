#!/bin/bash

# Git hook –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ - –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è git push
# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤ .git/hooks/post-receive –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ

echo "üîÑ Server post-receive hook: –ü–æ—á–∞—Ç–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –¥–µ–ø–ª–æ—é..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ —Ä–æ–±–æ—á—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é
cd /home/roman/new_onboarding

# –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–¥
echo "üì• –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–¥..."
git fetch origin
git reset --hard origin/main

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∑–º—ñ–Ω–∏ –≤ server/ –∞–±–æ docker-compose.yml
if git diff-tree --no-commit-id --name-only -r HEAD | grep -E "^(server/|docker-compose\.yml|\.env)" > /dev/null; then
    echo "üîç –í–∏—è–≤–ª–µ–Ω–æ –∑–º—ñ–Ω–∏ –≤ server/ –∞–±–æ docker-compose.yml"
    
    echo "üê≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏..."
    
    # –ó—É–ø–∏–Ω—è—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
    if [ -f "docker-compose.yml" ]; then
        echo "üõë –ó—É–ø–∏–Ω—è—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏..."
        docker compose down || true
        
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏..."
        docker compose up -d
        
        # –ß–µ–∫–∞—î–º–æ –ø–æ–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ –∑–∞–ø—É—Å—Ç—è—Ç—å—Å—è
        echo "‚è≥ –û—á—ñ–∫—É—î–º–æ –∑–∞–ø—É—Å–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤..."
        sleep 15
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å
        echo "üîç –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤:"
        docker compose ps
        
        # –¢–µ—Å—Ç—É—î–º–æ API
        echo "üß™ –¢–µ—Å—Ç—É—î–º–æ API..."
        if curl -s http://localhost:3001/api/health > /dev/null 2>&1; then
            echo "‚úÖ API –ø—Ä–∞—Ü—é—î!"
        else
            echo "‚ö†Ô∏è  API –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏."
            echo "üìã –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:"
            docker compose logs server --tail=20
        fi
        
        echo "üéâ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
    else
        echo "‚ö†Ô∏è  docker-compose.yml –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –¥–µ–ø–ª–æ–π."
    fi
else
    echo "‚ÑπÔ∏è  –ù–µ–º–∞—î –∑–º—ñ–Ω –≤ server/ –∞–±–æ docker-compose.yml. –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –¥–µ–ø–ª–æ–π."
fi

echo "‚úÖ Server post-receive hook –∑–∞–≤–µ—Ä—à–µ–Ω–æ."
