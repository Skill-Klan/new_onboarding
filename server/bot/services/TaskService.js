// –°–µ—Ä–≤—ñ—Å –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏

const { TaskData, Profession } = require('../types');

class TaskService {
  constructor(databaseService) {
    this.databaseService = databaseService;
    this.taskTemplates = this.initializeTaskTemplates();
  }

  /**
   * –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —à–∞–±–ª–æ–Ω—ñ–≤ –∑–∞–≤–¥–∞–Ω—å
   */
  initializeTaskTemplates() {
    return {
      [Profession.QA]: {
        title: '–¢–µ—Å—Ç–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è QA Engineer',
        description: '–ü—Ä–∞–∫—Ç–∏—á–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –Ω–∞–≤–∏—á–æ–∫ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è',
        content: `# –¢–µ—Å—Ç–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è QA Engineer

## –ó–∞–≤–¥–∞–Ω–Ω—è 1: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤–µ–±-–¥–æ–¥–∞—Ç–∫—É

–ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –≤–µ–±-—Å–∞–π—Ç: https://example.com

### –©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏:

1. **–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è**
   - –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—Å—ñ –æ—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —Å–∞–π—Ç—É
   - –ó–Ω–∞–π–¥—ñ—Ç—å —Ç–∞ –æ–ø–∏—à—ñ—Ç—å –∑–Ω–∞–π–¥–µ–Ω—ñ –±–∞–≥–∏
   - –ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ —Ä—ñ–∑–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

2. **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É**
   - –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞ —Ä—ñ–∑–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö
   - –ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—é
   - –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å

3. **–î–æ–∫—É–º–µ–Ω—Ç—É–≤–∞–Ω–Ω—è**
   - –°—Ç–≤–æ—Ä—ñ—Ç—å –∑–≤—ñ—Ç –ø—Ä–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
   - –û–ø–∏—à—ñ—Ç—å –∑–Ω–∞–π–¥–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏
   - –ó–∞–ø—Ä–æ–ø–æ–Ω—É–π—Ç–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

### –§–æ—Ä–º–∞—Ç –∑–≤—ñ—Ç—É:
- –ù–∞–∑–≤–∞ –±–∞–≥–∞
- –ö—Ä–æ–∫–∏ –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
- –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –§–∞–∫—Ç–∏—á–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç

**–¢–µ—Ä–º—ñ–Ω –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:** 3 –¥–Ω—ñ
**–§–æ—Ä–º–∞—Ç –∑–¥–∞—á—ñ:** –¢–µ–∫—Å—Ç–æ–≤–∏–π –∑–≤—ñ—Ç –∞–±–æ —Å–∫—Ä—ñ–Ω—à–æ—Ç–∏`

      },
      [Profession.BA]: {
        title: '–¢–µ—Å—Ç–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è Business Analyst',
        description: '–ü—Ä–∞–∫—Ç–∏—á–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏—Ö –Ω–∞–≤–∏—á–æ–∫',
        content: `# –¢–µ—Å—Ç–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è Business Analyst

## –ó–∞–≤–¥–∞–Ω–Ω—è: –ê–Ω–∞–ª—ñ–∑ –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—É

–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π—Ç–µ –ø—Ä–æ—Ü–µ—Å –æ–Ω–ª–∞–π–Ω-–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ñ.

### –©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏:

1. **–ê–Ω–∞–ª—ñ–∑ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É**
   - –û–ø–∏—à—ñ—Ç—å –ø–æ–∫—Ä–æ–∫–æ–≤–æ –ø—Ä–æ—Ü–µ—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
   - –í–∏–∑–Ω–∞—á—Ç–µ —É—á–∞—Å–Ω–∏–∫—ñ–≤ –ø—Ä–æ—Ü–µ—Å—É
   - –ó–Ω–∞–π–¥—ñ—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ñ –º—ñ—Å—Ü—è

2. **–ó–±—ñ—Ä –≤–∏–º–æ–≥**
   - –í–∏–∑–Ω–∞—á—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ –≤–∏–º–æ–≥–∏
   - –í–∏–∑–Ω–∞—á—ñ—Ç—å –Ω–µ—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ –≤–∏–º–æ–≥–∏
   - –ü—Ä—ñ–æ—Ä–∏—Ç–∏–∑—É–π—Ç–µ –≤–∏–º–æ–≥–∏

3. **–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –ø–æ–∫—Ä–∞—â–µ–Ω—å**
   - –ó–∞–ø—Ä–æ–ø–æ–Ω—É–π—Ç–µ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—é –ø—Ä–æ—Ü–µ—Å—É
   - –û–ø–∏—à—ñ—Ç—å –Ω–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å
   - –û—Ü—ñ–Ω—ñ—Ç—å –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å

### –§–æ—Ä–º–∞—Ç –∑–≤—ñ—Ç—É:
- –î—ñ–∞–≥—Ä–∞–º–∞ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É
- –°–ø–∏—Å–æ–∫ –≤–∏–º–æ–≥ –∑ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- –î—ñ–∞–≥—Ä–∞–º–∞ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É
- –û–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω

**–¢–µ—Ä–º—ñ–Ω –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:** 3 –¥–Ω—ñ
**–§–æ—Ä–º–∞—Ç –∑–¥–∞—á—ñ:** –î–æ–∫—É–º–µ–Ω—Ç –∑ –¥—ñ–∞–≥—Ä–∞–º–∞–º–∏`
      }
    };
  }

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—ñ—ó
   */
  generateTask(profession) {
    const template = this.taskTemplates[profession];
    if (!template) {
      throw new Error(`–ù–µ–≤—ñ–¥–æ–º–∞ –ø—Ä–æ—Ñ–µ—Å—ñ—è: ${profession}`);
    }

    return new TaskData(
      profession,
      template.title,
      template.description,
      template.content
    );
  }

  /**
   * –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–≤–¥–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
   */
  async sendTask(ctx, taskData) {
    try {
      // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
      await ctx.reply(`üìÑ **${taskData.title}**\n\n${taskData.description}`);

      // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≤–¥–∞–Ω–Ω—è
      await ctx.reply(taskData.content, { parse_mode: 'Markdown' });

      // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
      const { MessageTemplates } = require('../templates/messages');
      await ctx.reply(MessageTemplates.getTaskDeliveryMessage());

      // –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–¥–∞—á—ñ –∑–∞–≤–¥–∞–Ω–Ω—è
      const { KeyboardTemplates } = require('../templates/keyboards');
      await ctx.reply('–ì–æ—Ç–æ–≤—ñ –∑–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è?', KeyboardTemplates.getTaskCompletionKeyboard());

      return true;
    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∑–∞–≤–¥–∞–Ω–Ω—è:', error);
      throw error;
    }
  }

  /**
   * –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è
   */
  async trackTaskDelivery(userId, taskData) {
    try {
      await this.databaseService.saveTaskDelivery(userId, taskData);
    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –∑–∞–≤–¥–∞–Ω–Ω—è:', error);
      throw error;
    }
  }

  /**
   * –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–≤–¥–∞–Ω—å
   */
  async getTaskStatistics() {
    try {
      return await this.databaseService.getTaskStatistics();
    } catch (error) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–≤–¥–∞–Ω—å:', error);
      throw error;
    }
  }

  /**
   * –û–Ω–æ–≤–ª–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—É –∑–∞–≤–¥–∞–Ω–Ω—è
   */
  updateTaskTemplate(profession, newTemplate) {
    if (!this.taskTemplates[profession]) {
      throw new Error(`–ù–µ–≤—ñ–¥–æ–º–∞ –ø—Ä–æ—Ñ–µ—Å—ñ—è: ${profession}`);
    }

    this.taskTemplates[profession] = {
      ...this.taskTemplates[profession],
      ...newTemplate
    };
  }

  /**
   * –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –ø—Ä–æ—Ñ–µ—Å—ñ–π
   */
  getAvailableProfessions() {
    return Object.keys(this.taskTemplates);
  }
}

module.exports = TaskService;
