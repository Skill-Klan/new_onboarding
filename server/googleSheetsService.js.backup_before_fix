const { google } = require('googleapis');
const fs = require('fs');
const path = require('path');

const SPREADSHEET_ID = '1yHGwLrSDkZPOh7uQoKgD7wSf9Twao7gAtc2hA4EwhpI';
const SHEET_NAME = '–∑–∞–≥–∞–ª—å–Ω–∏–π';
const CREDENTIALS_PATH = path.join(__dirname, 'skillklan-app-9a0e1d9f149a.json');

class GoogleSheetsService {
  constructor() {
    this.authWrite = null;
    this.sheetsWrite = null;
    this.auth = null;
    this.sheets = null;
  }

  async initialize() {
    try {
      const credentials = JSON.parse(fs.readFileSync(CREDENTIALS_PATH, 'utf8'));
      this.auth = new google.auth.GoogleAuth({
        credentials: credentials,
        scopes: ['https://www.googleapis.com/auth/spreadsheets.readonly'],
      });
      const authClient = await this.auth.getClient();
      this.sheets = google.sheets({ version: 'v4', auth: authClient });
      console.log('‚úÖ Google Sheets Service —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
      return true;
    } catch (error) {
      console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Google Sheets Service:', error.message);
      return false;
    }
  }

  async getGlobalSummary() {
    try {
      if (!this.sheets) {
        await this.initialize();
      }
      const response = await this.sheets.spreadsheets.get({
        spreadsheetId: SPREADSHEET_ID,
        ranges: [],
        includeGridData: true,
      });

      const sheetData = response.data.sheets?.[0];
      const gridData = sheetData?.data?.[0];
      const rowData = gridData?.rowData || [];
      if (!rowData.length) return { totalGivenToSchoolUSD: 0, remainderToSchoolUSD: 0 };

      const headerRowIndex = 1;
      const headers = (rowData[headerRowIndex]?.values || []).map(c => c?.formattedValue || c?.effectiveValue?.stringValue || '');

      const getIndex = (title) => {
        const needle = title.toLowerCase();
        for (let i = 0; i < headers.length; i++) {
          const h = (headers[i] || '').toLowerCase().trim();
          if (h === needle || h.includes(needle)) return i;
        }
        return -1;
      };

      const colSchoolUSD = getIndex('–≤—Å—å–æ–≥–æ –≤—ñ–¥–¥–∞–Ω–æ —à–∫–æ–ª—ñ –≤ –¥–æ–ª–∞—Ä–∞—Ö');
      const colRemainderSchool = getIndex('–∑–∞–ª–∏—à–æ–∫ —à–∫–æ–ª—ñ –≤ –¥–æ–ª–∞—Ä–∞—Ö');

      let totalGivenToSchoolUSD = 0;
      let remainderToSchoolUSD = 0;

      const parseNumber = (cell) => {
        if (!cell) return 0;
        const val = cell.formattedValue || cell.effectiveValue?.stringValue || '';
        if (typeof val === 'number') return val;
        const n = parseFloat(String(val).replace(/[^0-9.,-]/g, '').replace(',', '.'));
        return isNaN(n) ? 0 : n;
      };

      for (let i = headerRowIndex + 1; i < rowData.length; i++) {
        const row = rowData[i]?.values || [];
        if (colSchoolUSD !== -1) totalGivenToSchoolUSD += parseNumber(row[colSchoolUSD]);
        if (colRemainderSchool !== -1) remainderToSchoolUSD += parseNumber(row[colRemainderSchool]);
      }

      return { totalGivenToSchoolUSD, remainderToSchoolUSD };
    } catch (error) {
      console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó Google Sheets:', error.message);
      return { totalGivenToSchoolUSD: 0, remainderToSchoolUSD: 0 };
    }
  }


  
  async initializeWrite() {
    try {
      const credentials = JSON.parse(fs.readFileSync(CREDENTIALS_PATH, 'utf8'));
      this.authWrite = new google.auth.GoogleAuth({
        credentials: credentials,
        scopes: ['https://www.googleapis.com/auth/spreadsheets'],
      });
      const authClient = await this.authWrite.getClient();
      this.sheetsWrite = google.sheets({ version: 'v4', auth: authClient });
      console.log('‚úÖ Google Sheets Write Client —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
      return true;
    } catch (error) {
      console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Write Client:', error.message);
      return false;
    }
  }

  async getPayingStudents() {
    try {
      if (!this.sheets) {
        await this.initialize();
      }
      
      const response = await this.sheets.spreadsheets.get({
        spreadsheetId: SPREADSHEET_ID,
        ranges: [SHEET_NAME + '!A:Z'],
        includeGridData: true,
      });

      const sheetData = response.data.sheets[0];
      if (!sheetData?.data?.[0]) {
        return [];
      }

      const gridData = sheetData.data[0];
      const rowData = gridData.rowData || [];
      
      const headerRowIndex = 1;
      if (headerRowIndex >= rowData.length) {
        return [];
      }

      const headerCells = rowData[headerRowIndex].values;
      const headers = headerCells.map(cell => {
        return cell?.formattedValue || cell?.effectiveValue?.stringValue || '';
      });

      const getIndex = (title) => {
        const needle = title.toLowerCase();
        for (let i = 0; i < headers.length; i++) {
          const h = (headers[i] || '').toLowerCase().trim();
          if (h === needle || h.includes(needle)) return i;
        }
        return -1;
      };

      const colName = getIndex('—ñ–º');
      const colTotalGivenUSD = getIndex('–≤—Å—å–æ–≥–æ –≤—ñ–¥–¥–∞–Ω–æ –≤ –¥–æ–ª–∞—Ä–∞—Ö');
      const colTotalGivenToSchoolUSD = getIndex('–≤—Å—å–æ–≥–æ –≤—ñ–¥–¥–∞–Ω–æ —à–∫–æ–ª—ñ –≤ –¥–æ–ª–∞—Ä–∞—Ö');
      const colRemainderSchool = getIndex('–∑–∞–ª–∏—à–æ–∫ —à–∫–æ–ª—ñ –≤ –¥–æ–ª–∞—Ä–∞—Ö');
      const colPaymentStatus = getIndex('—Å—Ç–∞—Ç—É—Å –≤–∏–ø–ª–∞—Ç');

      const parseNumber = (cell) => {
        if (!cell) return null;
        const val = cell.formattedValue || cell.effectiveValue?.stringValue || cell.effectiveValue?.numberValue;
        if (typeof val === 'number') return val;
        const n = parseFloat(String(val).replace(/[^0-9.,-]/g, '').replace(',', '.'));
        return isNaN(n) ? null : n;
      };

      const students = [];

      for (let i = headerRowIndex + 1; i < rowData.length; i++) {
        const row = rowData[i]?.values || [];
        const studentName = row[colName]?.formattedValue || row[colName]?.effectiveValue?.stringValue || '';
        
        if (!studentName || studentName.trim() === '') continue;
        if (studentName.toLowerCase().includes("–≤—Å—å–æ–≥–æ") || studentName.startsWith("$")) continue;

        const totalGivenUSD = parseNumber(row[colTotalGivenUSD]);
        const totalGivenToSchoolUSD = parseNumber(row[colTotalGivenToSchoolUSD]);
        const remainderToSchoolUSD = parseNumber(row[colRemainderSchool]);
        const paymentStatus = row[colPaymentStatus]?.formattedValue || row[colPaymentStatus]?.effectiveValue?.stringValue || null;

        students.push({
          student_name: studentName.trim(),
          total_given_usd: totalGivenUSD,
          total_given_to_school_usd: totalGivenToSchoolUSD,
          remainder_to_school_usd: remainderToSchoolUSD,
          payment_status: paymentStatus
        });
      }

      return students;
    } catch (error) {
      console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ —â–æ –≤–∏–ø–ª–∞—á—É—é—Ç—å:', error.message);
      return [];
    }
  }
  
  async addPaymentRecord(studentName, paymentDate, amount, usdRate) {
    try {
      if (!this.sheets) {
        await this.initialize();
      }

      if (!this.sheetsWrite) {
        await this.initializeWrite();
      }
      console.log(`üìù –î–æ–¥–∞–≤–∞–Ω–Ω—è –æ–ø–ª–∞—Ç–∏ –¥–ª—è ${studentName}`);
      
      // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –≤—Å—ñ—î—ó —Ç–∞–±–ª–∏—Ü—ñ
      const response = await this.sheets.spreadsheets.get({
        spreadsheetId: SPREADSHEET_ID,
        ranges: [SHEET_NAME + '!A:Z'],
        includeGridData: true,
      });

      const sheetData = response.data.sheets[0];
      if (!sheetData?.data?.[0]) {
        throw new Error('–¢–∞–±–ª–∏—Ü—è –ø–æ—Ä–æ–∂–Ω—è');
      }

      const gridData = sheetData.data[0];
      const rowData = gridData.rowData || [];
      
      const headerRowIndex = 1;
      if (headerRowIndex >= rowData.length) {
        throw new Error('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Ä—è–¥–æ–∫ –∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏');
      }

      // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —ñ–Ω–¥–µ–∫—Å–∏ –∫–æ–ª–æ–Ω–æ–∫
      const headerCells = rowData[headerRowIndex].values;
      const headers = headerCells.map(cell => {
        return cell?.formattedValue || cell?.effectiveValue?.stringValue || '';
      });

      const getIndex = (title) => {
        const needle = title.toLowerCase();
        for (let i = 0; i < headers.length; i++) {
          const h = (headers[i] || '').toLowerCase().trim();
          if (h === needle || h.includes(needle)) return i;
        }
        return -1;
      };

      const colName = getIndex('—ñ–º');
      const colDate = getIndex('–¥–∞—Ç–∞');
      console.log("Debug: colName=", colName, "colDate=", colDate, "headers=", headers);
      const colAmount = getIndex('—Å—É–º–∞');
      const colUsdRate = getIndex('–∫—É—Ä—Å');

      if (colName === -1) {
        throw new Error('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∫–æ–ª–æ–Ω–∫—É –∑ —ñ–º\'—è–º');
      }

      // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
      console.log("Debug: –®—É–∫–∞—î–º–æ —Å—Ç—É–¥–µ–Ω—Ç–∞", studentName);
      let studentRowIndex = -1;
      for (let i = headerRowIndex + 1; i < rowData.length; i++) {
        const row = rowData[i]?.values || [];
        const cellName = row[colName]?.formattedValue || row[colName]?.effectiveValue?.stringValue || '';
        if (cellName.trim().toLowerCase() === studentName.trim().toLowerCase()) {
          studentRowIndex = i;
          break;
        }
      }

      console.log("Debug: –ó–Ω–∞–π–¥–µ–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤ —Ä—è–¥–∫—É", studentRowIndex + 1);
      if (studentRowIndex === -1) {
        throw new Error(`–°—Ç—É–¥–µ–Ω—Ç ${studentName} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ`);
      }

      // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –æ—Å—Ç–∞–Ω–Ω—é –∑–∞–ø–æ–≤–Ω–µ–Ω—É —Ä—è–¥–æ–∫ –¥–ª—è —Ü—å–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
      let lastFilledRowIndex = -1;
      console.log("Debug: –ü–æ—á–∏–Ω–∞—î–º–æ –ø–æ—à—É–∫ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏—Ö —Ä—è–¥–∫—ñ–≤ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞");
      for (let i = studentRowIndex; i < rowData.length; i++) {
        const row = rowData[i]?.values || [];
        const cellName = row[colName]?.formattedValue || row[colName]?.effectiveValue?.stringValue || '';
        
        // –Ø–∫—â–æ —ñ–º\'—è –∑–º—ñ–Ω–∏–ª–æ—Å—è - –≤–∏—Ö—ñ–¥ –∑ —Ü–∏–∫–ª—É (–ø–æ—á–∞–ª–∏—Å—è —ñ–Ω—à—ñ —Å—Ç—É–¥–µ–Ω—Ç–∏)
        if (cellName.trim().toLowerCase() !== studentName.trim().toLowerCase()) {
          break;
        }
        
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∑–Ω–∞—á–µ–Ω–Ω—è –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö —Å—É–º
        let hasValue = false;
        for (let colIdx = 2; colIdx <= 5; colIdx++) {
          const val = row[colIdx]?.formattedValue || row[colIdx]?.effectiveValue?.stringValue || row[colIdx]?.effectiveValue?.numberValue || "";
          if (val && val !== "") { hasValue = true; break; }
        }
        if (hasValue) { lastFilledRowIndex = i; console.log("Debug: –ó–Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π —Ä—è–¥–æ–∫", i + 1); }
      }

      if (lastFilledRowIndex === -1) {
        throw new Error('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏—Ö —Ä—è–¥–∫—ñ–≤ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞');
      }

      // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—É–ø–Ω—É –ø–æ—Ä–æ–∂–Ω—é —Ä—è–¥–æ–∫
      let nextEmptyRowIndex = -1;
      for (let i = lastFilledRowIndex + 1; i < rowData.length + 10; i++) {
        const row = rowData[i]?.values || [];
        const cellName = row[colName]?.formattedValue || row[colName]?.effectiveValue?.stringValue || '';
        
        // –Ø–∫—â–æ —ñ–º\'—è –∑–º—ñ–Ω–∏–ª–æ—Å—è –∞–±–æ —Ä—è–¥–∫–∞ –Ω–µ–º–∞—î - —Ü–µ –Ω–∞—à–∞ –ø–æ—Ä–æ–∂–Ω—è —Ä—è–¥–æ–∫
        if (i >= rowData.length || cellName.trim().toLowerCase() !== studentName.trim().toLowerCase()) {
          nextEmptyRowIndex = i;
          break;
        }
      }

      if (nextEmptyRowIndex === -1) {
        throw new Error('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø–æ—Ä–æ–∂–Ω—é —Ä—è–¥–æ–∫');
      }

      console.log(`üìç –û—Å—Ç–∞–Ω–Ω—è –∑–∞–ø–æ–≤–Ω–µ–Ω–∞ —Ä—è–¥–æ–∫: ${lastFilledRowIndex + 1}, –ù–æ–≤–∞ —Ä—è–¥–æ–∫: ${nextEmptyRowIndex + 1}`);

      // –ì–æ—Ç—É—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∫–∞
      const lastFilledRow = rowData[lastFilledRowIndex]?.values || [];
      const newRowValues = [];
      
      for (let col = 0; col < headers.length; col++) {
        if (col === colDate) {
          newRowValues.push(paymentDate);
        } else if (col === colAmount && colAmount !== -1) {
          newRowValues.push(amount);
        } else if (col === colUsdRate && colUsdRate !== -1) {
          newRowValues.push(usdRate);
        } else if (col === colName) {
          newRowValues.push(studentName);
        } else {
          // –ö–æ–ø—ñ—é—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —Ä—è–¥–∫–∏
          const cell = lastFilledRow[col];
          if (cell) {
            const val = cell.formattedValue || cell.effectiveValue?.stringValue || cell.effectiveValue?.numberValue;
            newRowValues.push(val || '');
          } else {
            newRowValues.push('');
          }
        }
      }

      // –û–Ω–æ–≤–ª—é—î–º–æ Google Sheet
      const updateResponse = await this.sheetsWrite.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SHEET_NAME}!A${nextEmptyRowIndex + 1}:Z${nextEmptyRowIndex + 1}`,
        valueInputOption: 'RAW',
        resource: {
          values: [newRowValues]
        }
      });

      console.log('‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–∞');
      return { success: true, row: nextEmptyRowIndex + 1 };
    } catch (error) {
      console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –æ–ø–ª–∞—Ç–∏:', error.message);
      throw error;
    }
  }

}

module.exports = new GoogleSheetsService();
