name: ğŸš€ Manual Deploy (Docker)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
        - staging
        - production
      force:
        description: 'Force deployment even if health checks fail'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  DOCKER_BUILDKIT: 1

jobs:
  deploy:
    name: ğŸš€ Manual Deploy
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          server/package-lock.json
          miniapp/package-lock.json
    
    - name: ğŸ“¦ Install server dependencies
      run: |
        echo "ğŸ“¦ Installing server dependencies..."
        cd server
        npm ci
    
    - name: ğŸ“¦ Install miniapp dependencies
      run: |
        echo "ğŸ“¦ Installing MiniApp dependencies..."
        cd miniapp
        npm ci
    
    - name: ğŸ§ª Run server tests
      run: |
        echo "ğŸ§ª Running server tests..."
        cd server
        if npm run test; then
          echo "âœ… Server tests passed"
        else
          echo "âš ï¸  Server tests failed, but continuing deployment"
        fi
    
    - name: ğŸ§ª Run miniapp tests
      run: |
        echo "ğŸ§ª Running MiniApp tests..."
        cd miniapp
        if npm run test; then
          echo "âœ… MiniApp tests passed"
        else
          echo "âš ï¸  MiniApp tests failed, but continuing deployment"
        fi
    
    - name: ğŸ—ï¸ Build MiniApp
      run: |
        echo "ğŸ—ï¸ Building MiniApp..."
        cd miniapp
        npm run build
    
    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: ğŸš€ Deploy to server
      run: |
        echo "ğŸš€ Starting manual Docker deployment..."
        
        # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ°Ñ€Ñ…Ñ–Ğ²Ñƒ Ğ´Ğ»Ñ Ğ²ÑÑŒĞ¾Ğ³Ğ¾
        tar -czf manual-deploy.tar.gz server/ miniapp/dist/ docker/ docker-compose.yml docker-*.sh
        echo "ğŸ“¦ Archive created: manual-deploy.tar.gz"
        
        # Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ“¤ Uploading to server..."
        scp -o StrictHostKeyChecking=no manual-deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        
        # Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ñ–
        echo "ğŸ”§ Executing deployment commands on server..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ”„ Starting manual Docker deployment process..."
          cd /var/www/skillklan
          
          # Ğ¡Ñ‚Ğ¾Ğ¿ Ğ²ÑÑ–Ñ… ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          echo "â¹ï¸  Stopping all services..."
          if [ -f "docker-compose.yml" ]; then
            docker-compose down --remove-orphans || echo "âš ï¸  Docker services were not running"
          fi
          
          # Ğ—ÑƒĞ¿Ğ¸Ğ½ĞºĞ° PM2 Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ² (ÑĞºÑ‰Ğ¾ Ñ”)
          if command -v pm2 &> /dev/null; then
            pm2 stop all || echo "âš ï¸  PM2 processes were not running"
          fi
          
          # Ğ—ÑƒĞ¿Ğ¸Ğ½ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ¸Ñ… ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          sudo systemctl stop nginx || echo "âš ï¸  Nginx was not running"
          sudo systemctl stop postgresql || echo "âš ï¸  PostgreSQL was not running"
          
          # Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ° ĞºĞ¾Ğ¿Ñ–Ñ
          if [ -d "backup" ]; then
            rm -rf backup
          fi
          mkdir backup
          
          if [ -d "server" ]; then
            echo "ğŸ’¾ Backing up server..."
            mv server backup/
          fi
          
          if [ -d "public" ]; then
            echo "ğŸ’¾ Backing up frontend..."
            mv public backup/
          fi
          
          if [ -d "docker" ]; then
            echo "ğŸ’¾ Backing up docker config..."
            mv docker backup/
          fi
          
          # Ğ Ğ¾Ğ·Ğ¿Ğ°ĞºÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ½Ğ¾Ğ²Ğ¾Ñ— Ğ²ĞµÑ€ÑÑ–Ñ—
          echo "ğŸ“¦ Extracting new version..."
          cd /tmp
          tar -xzf manual-deploy.tar.gz
          mv server /var/www/skillklan/
          mv dist /var/www/skillklan/public
          mv docker /var/www/skillklan/
          mv docker-compose.yml /var/www/skillklan/
          mv docker-*.sh /var/www/skillklan/
          
          # ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
          echo "ğŸ”§ Setting up server..."
          cd /var/www/skillklan/server
          npm ci --production
          
          # ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ frontend
          echo "ğŸ”§ Setting up frontend..."
          sudo chown -R www-data:www-data /var/www/skillklan/public
          sudo chmod -R 755 /var/www/skillklan/public
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞº Docker ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          echo "ğŸš€ Starting Docker services..."
          cd /var/www/skillklan
          chmod +x docker-*.sh
          ./docker-deploy.sh deploy
          
          # ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ
          rm /tmp/manual-deploy.tar.gz
          
          echo "âœ… Manual Docker deployment completed successfully!"
        EOF
        
        echo "âœ… Manual Docker deployment completed!"
    
    - name: ğŸ” Health checks
      run: |
        echo "ğŸ” Performing health checks..."
        
        # Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºĞ¸ ÑĞµÑ€Ğ²Ñ–ÑĞ¸ Ğ·Ğ°Ğ¿ÑƒÑÑ‚ÑÑ‚ÑŒÑÑ
        echo "â³ Waiting for services to start..."
        sleep 45
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ¥ Checking server health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/api/health; then
          echo "âœ… Server is healthy"
        else
          echo "âŒ Server health check failed"
          if [ "${{ github.event.inputs.force }}" = "false" ]; then
            exit 1
          fi
        fi
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ frontend
        echo "ğŸ¥ Checking frontend health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/; then
          echo "âœ… Frontend is healthy"
        else
          echo "âŒ Frontend health check failed"
          if [ "${{ github.event.inputs.force }}" = "false" ]; then
            exit 1
          fi
        fi
    
    - name: ğŸ“§ Deployment summary
      run: |
        echo "ğŸ‰ Manual Docker deployment completed successfully!"
        echo "   Environment: ${{ github.event.inputs.environment }}"
        echo "   Server: ${{ secrets.SERVER_HOST }}"
        echo "   Timestamp: $(date -u)"
        echo "   Commit: ${{ github.sha }}"
        echo "   Type: Manual Docker deployment (server + frontend)"
        echo "   Force: ${{ github.event.inputs.force }}"

  rollback:
    name: ğŸ”„ Rollback
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    if: failure()
    
    steps:
    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: ğŸ”„ Rollback deployment
      run: |
        echo "ğŸ”„ Starting rollback process..."
        
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ”„ Starting rollback process..."
          cd /var/www/skillklan
          
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°ÑĞ²Ğ½Ñ–ÑÑ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¸Ñ… ĞºĞ¾Ğ¿Ñ–Ğ¹
          if [ ! -d "backup" ]; then
            echo "âŒ No backup directory found"
            exit 1
          fi
          
          echo "ğŸ“‹ Available backups:"
          ls -la backup/
          
          # Ğ¡Ñ‚Ğ¾Ğ¿ Docker ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          echo "â¹ï¸  Stopping Docker services..."
          if [ -f "docker-compose.yml" ]; then
            docker-compose down --remove-orphans || echo "âš ï¸  Docker services were not running"
          fi
          
          # Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ Ñ‰Ğ¾ Ğ²Ñ–Ğ´ĞºĞ°Ñ‚ÑƒĞ²Ğ°Ñ‚Ğ¸
          if [ -d "backup/server" ]; then
            echo "ğŸ”„ Rolling back server..."
            if [ -d "server" ]; then
              rm -rf server
            fi
            mv backup/server ./
          fi
          
          if [ -d "backup/public" ]; then
            echo "ğŸ”„ Rolling back frontend..."
            if [ -d "public" ]; then
              rm -rf public
            fi
            mv backup/public ./
          fi
          
          if [ -d "backup/docker" ]; then
            echo "ğŸ”„ Rolling back docker config..."
            if [ -d "docker" ]; then
              rm -rf docker
            fi
            mv backup/docker ./
          fi
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¾Ñ€Ğ¸Ğ³Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğ¸Ñ… ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          if [ -d "server" ] && [ -f "ecosystem.config.js" ]; then
            echo "ğŸš€ Starting server with PM2..."
            cd server
            pm2 start ecosystem.config.js --env ${{ github.event.inputs.environment }}
            pm2 save
            cd ..
          elif [ -d "docker" ] && [ -f "docker-compose.yml" ]; then
            echo "ğŸš€ Starting Docker services..."
            chmod +x docker-*.sh
            ./docker-deploy.sh deploy
          fi
          
          if [ -d "public" ]; then
            echo "ğŸš€ Starting Nginx..."
            sudo systemctl start nginx
          fi
          
          # ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ
          rm -rf backup
          
          echo "âœ… Rollback completed successfully!"
        EOF
        
        echo "âœ… Rollback completed!"
    
    - name: ğŸ” Health checks after rollback
      run: |
        echo "ğŸ” Performing health checks after rollback..."
        
        # Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºĞ¸ ÑĞµÑ€Ğ²Ñ–ÑĞ¸ Ğ·Ğ°Ğ¿ÑƒÑÑ‚ÑÑ‚ÑŒÑÑ
        echo "â³ Waiting for services to start..."
        sleep 30
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ¥ Checking server health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/api/health; then
          echo "âœ… Server is healthy after rollback"
        else
          echo "âŒ Server health check failed after rollback"
        fi
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ frontend
        echo "ğŸ¥ Checking frontend health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/; then
          echo "âœ… Frontend is healthy after rollback"
        else
          echo "âŒ Frontend health check failed after rollback"
        fi
    
    - name: ğŸ“§ Rollback summary
      run: |
        echo "ğŸ”„ Rollback completed!"
        echo "   Environment: ${{ github.event.inputs.environment }}"
        echo "   Server: ${{ secrets.SERVER_HOST }}"
        echo "   Timestamp: $(date -u)"
        echo "   Type: Rollback to previous version"
