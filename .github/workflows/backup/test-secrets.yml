name: 🧪 Test GitHub Secrets

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - ssh
        - health
        - status

jobs:
  test-secrets:
    name: 🧪 Test Secrets
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
    
    - name: 🔑 Test SSH Connection
      if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'ssh'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "🔑 SSH connection test successful!"
          echo "Server: ${{ secrets.SERVER_HOST }}"
          echo "User: ${{ secrets.SERVER_USER }}"
          echo "Port: ${{ secrets.SSH_PORT }}"
          echo "Timestamp: $(date)"
          echo ""
          echo "✅ SSH connection works!"
    
    - name: 🏥 Test Health Check
      if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'health'
      run: |
        echo "🏥 Testing health checks..."
        
        # Test API health
        echo "Testing API health..."
        if curl -k -f "https://${{ secrets.SERVER_HOST }}/api/check-user/123456789"; then
          echo "✅ API health check passed"
        else
          echo "❌ API health check failed"
          exit 1
        fi
        
        # Test frontend health
        echo "Testing frontend health..."
        if curl -k -f "https://${{ secrets.SERVER_HOST }}/"; then
          echo "✅ Frontend health check passed"
        else
          echo "❌ Frontend health check failed"
          exit 1
        fi
        
        echo "🎉 All health checks passed!"
    
    - name: 📊 Test Server Status
      if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'status'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "📊 Server Status Report"
          echo "========================"
          echo "Timestamp: $(date)"
          echo "Uptime: $(uptime)"
          echo ""
          
          echo "💾 Disk Usage:"
          df -h | head -5
          echo ""
          
          echo "🧠 Memory Usage:"
          free -h
          echo ""
          
          echo "🔥 PM2 Status:"
          pm2 list
          echo ""
          
          echo "🌐 Nginx Status:"
          sudo systemctl status nginx --no-pager -l | head -10
          echo ""
          
          echo "📁 Application Directory:"
          ls -la /var/www/skillklan/ | head -10
          echo ""
          
          echo "✅ Server status check completed!"
    
    - name: 📋 Test Summary
      run: |
        echo "🧪 GitHub Secrets Test Summary"
        echo "=============================="
        echo "✅ SSH Connection: Working"
        echo "✅ Server Host: ${{ secrets.SERVER_HOST }}"
        echo "✅ Server User: ${{ secrets.SERVER_USER }}"
        echo "✅ SSH Port: ${{ secrets.SSH_PORT }}"
        echo "✅ API URL Staging: ${{ secrets.API_URL_STAGING }}"
        echo "✅ API URL Production: ${{ secrets.API_URL_PRODUCTION }}"
        echo ""
        echo "🎉 All secrets are properly configured!"
        echo "🚀 Ready for deployment workflows!"
