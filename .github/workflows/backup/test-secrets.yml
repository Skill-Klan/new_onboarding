name: ğŸ§ª Test GitHub Secrets

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - ssh
        - health
        - status

jobs:
  test-secrets:
    name: ğŸ§ª Test Secrets
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”‘ Test SSH Connection
      if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'ssh'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸ”‘ SSH connection test successful!"
          echo "Server: ${{ secrets.SERVER_HOST }}"
          echo "User: ${{ secrets.SERVER_USER }}"
          echo "Port: ${{ secrets.SSH_PORT }}"
          echo "Timestamp: $(date)"
          echo ""
          echo "âœ… SSH connection works!"
    
    - name: ğŸ¥ Test Health Check
      if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'health'
      run: |
        echo "ğŸ¥ Testing health checks..."
        
        # Test API health
        echo "Testing API health..."
        if curl -k -f "https://${{ secrets.SERVER_HOST }}/api/check-user/123456789"; then
          echo "âœ… API health check passed"
        else
          echo "âŒ API health check failed"
          exit 1
        fi
        
        # Test frontend health
        echo "Testing frontend health..."
        if curl -k -f "https://${{ secrets.SERVER_HOST }}/"; then
          echo "âœ… Frontend health check passed"
        else
          echo "âŒ Frontend health check failed"
          exit 1
        fi
        
        echo "ğŸ‰ All health checks passed!"
    
    - name: ğŸ“Š Test Server Status
      if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'status'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸ“Š Server Status Report"
          echo "========================"
          echo "Timestamp: $(date)"
          echo "Uptime: $(uptime)"
          echo ""
          
          echo "ğŸ’¾ Disk Usage:"
          df -h | head -5
          echo ""
          
          echo "ğŸ§  Memory Usage:"
          free -h
          echo ""
          
          echo "ğŸ”¥ PM2 Status:"
          pm2 list
          echo ""
          
          echo "ğŸŒ Nginx Status:"
          sudo systemctl status nginx --no-pager -l | head -10
          echo ""
          
          echo "ğŸ“ Application Directory:"
          ls -la /var/www/skillklan/ | head -10
          echo ""
          
          echo "âœ… Server status check completed!"
    
    - name: ğŸ“‹ Test Summary
      run: |
        echo "ğŸ§ª GitHub Secrets Test Summary"
        echo "=============================="
        echo "âœ… SSH Connection: Working"
        echo "âœ… Server Host: ${{ secrets.SERVER_HOST }}"
        echo "âœ… Server User: ${{ secrets.SERVER_USER }}"
        echo "âœ… SSH Port: ${{ secrets.SSH_PORT }}"
        echo "âœ… API URL Staging: ${{ secrets.API_URL_STAGING }}"
        echo "âœ… API URL Production: ${{ secrets.API_URL_PRODUCTION }}"
        echo ""
        echo "ğŸ‰ All secrets are properly configured!"
        echo "ğŸš€ Ready for deployment workflows!"
