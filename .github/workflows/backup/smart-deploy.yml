name: ğŸš€ Smart Deploy (Docker)

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      force:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  DOCKER_BUILDKIT: 1

jobs:
  analyze-changes:
    name: ğŸ” Analyze Changes
    runs-on: ubuntu-latest
    outputs:
      server-changed: ${{ steps.changes.outputs.server }}
      miniapp-changed: ${{ steps.changes.outputs.miniapp }}
      config-changed: ${{ steps.changes.outputs.config }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ” Detect changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          server:
            - 'server/**'
            - 'docker/**'
            - 'docker-compose.yml'
            - 'docker-deploy.sh'
          miniapp:
            - 'miniapp/**'
          config:
            - '.github/**'
            - '*.md'
            - '*.sh'

  deploy-server:
    name: ğŸ³ Deploy Server (Docker)
    runs-on: ubuntu-latest
    needs: analyze-changes
    if: needs.analyze-changes.outputs.server-changed == 'true'
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: ğŸš€ Deploy to server
      run: |
        echo "ğŸš€ Starting Docker server deployment..."
        
        # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ°Ñ€Ñ…Ñ–Ğ²Ñƒ Ğ´Ğ»Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
        tar -czf server-deploy.tar.gz server/ docker/ docker-compose.yml docker-deploy.sh docker-backup.sh docker-monitor.sh
        echo "ğŸ“¦ Archive created: server-deploy.tar.gz"
        
        # Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ“¤ Uploading to server..."
        scp -o StrictHostKeyChecking=no server-deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        
        # Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ñ–
        echo "ğŸ”§ Executing deployment commands on server..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ”„ Starting Docker server deployment process..."
          cd /var/www/skillklan
          
          # Ğ¡Ñ‚Ğ¾Ğ¿ Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¸Ñ… ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          echo "â¹ï¸  Stopping current services..."
          if [ -f "docker-compose.yml" ]; then
            docker-compose down --remove-orphans || echo "âš ï¸  Docker services were not running"
          fi
          
          # Ğ—ÑƒĞ¿Ğ¸Ğ½ĞºĞ° PM2 Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ² (ÑĞºÑ‰Ğ¾ Ñ”)
          if command -v pm2 &> /dev/null; then
            pm2 stop all || echo "âš ï¸  PM2 processes were not running"
          fi
          
          # Ğ—ÑƒĞ¿Ğ¸Ğ½ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ¸Ñ… ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          sudo systemctl stop nginx || echo "âš ï¸  Nginx was not running"
          sudo systemctl stop postgresql || echo "âš ï¸  PostgreSQL was not running"
          
          # Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ° ĞºĞ¾Ğ¿Ñ–Ñ
          if [ -d "backup" ]; then
            rm -rf backup
          fi
          mkdir backup
          
          if [ -d "server" ]; then
            echo "ğŸ’¾ Backing up server..."
            mv server backup/
          fi
          
          if [ -d "docker" ]; then
            echo "ğŸ’¾ Backing up docker config..."
            mv docker backup/
          fi
          
          # Ğ Ğ¾Ğ·Ğ¿Ğ°ĞºÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ½Ğ¾Ğ²Ğ¾Ñ— Ğ²ĞµÑ€ÑÑ–Ñ—
          echo "ğŸ“¦ Extracting new version..."
          cd /tmp
          tar -xzf server-deploy.tar.gz
          mv server /var/www/skillklan/
          mv docker /var/www/skillklan/
          mv docker-compose.yml /var/www/skillklan/
          mv docker-*.sh /var/www/skillklan/
          
          # Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹
          echo "ğŸ“¥ Installing dependencies..."
          cd /var/www/skillklan/server
          npm ci --production
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞº Docker ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          echo "ğŸš€ Starting Docker services..."
          cd /var/www/skillklan
          chmod +x docker-*.sh
          ./docker-deploy.sh deploy
          
          # ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ
          rm /tmp/server-deploy.tar.gz
          
          echo "âœ… Docker server deployment completed successfully!"
        EOF
        
        echo "âœ… Docker server deployment completed!"

  deploy-miniapp:
    name: ğŸ¨ Deploy MiniApp
    runs-on: ubuntu-latest
    needs: analyze-changes
    if: needs.analyze-changes.outputs.miniapp-changed == 'true'
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: miniapp/package-lock.json
    
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ“¦ Installing MiniApp dependencies..."
        cd miniapp
        npm ci
    
    - name: ğŸ§ª Run tests
      run: |
        echo "ğŸ§ª Running MiniApp tests..."
        cd miniapp
        if npm run test; then
          echo "âœ… Tests passed"
        else
          echo "âš ï¸  Tests failed, but continuing deployment"
        fi
    
    - name: ğŸ—ï¸ Build MiniApp
      run: |
        echo "ğŸ—ï¸ Building MiniApp..."
        cd miniapp
        npm run build
    
    - name: ğŸš€ Deploy to server
      run: |
        echo "ğŸš€ Starting MiniApp deployment..."
        
        # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ°Ñ€Ñ…Ñ–Ğ²Ñƒ Ğ´Ğ»Ñ frontend
        tar -czf miniapp-deploy.tar.gz miniapp/dist/
        echo "ğŸ“¦ Archive created: miniapp-deploy.tar.gz"
        
        # Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ“¤ Uploading to server..."
        scp -o StrictHostKeyChecking=no miniapp-deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        
        # Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ñ–
        echo "ğŸ”§ Executing deployment commands on server..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ”„ Starting MiniApp deployment process..."
          cd /var/www/skillklan
          
          # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ñ— Ğ´Ğ»Ñ frontend
          mkdir -p public
          
          # Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ° ĞºĞ¾Ğ¿Ñ–Ñ
          if [ -d "public" ] && [ "$(ls -A public)" ]; then
            echo "ğŸ’¾ Backing up frontend..."
            mv public backup/public
          fi
          
          # Ğ Ğ¾Ğ·Ğ¿Ğ°ĞºÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ½Ğ¾Ğ²Ğ¾Ñ— Ğ²ĞµÑ€ÑÑ–Ñ—
          echo "ğŸ“¦ Extracting new version..."
          cd /tmp
          tar -xzf miniapp-deploy.tar.gz
          mv dist /var/www/skillklan/public
          
          # ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ñƒ
          echo "ğŸ”§ Setting up permissions..."
          sudo chown -R www-data:www-data /var/www/skillklan/public
          sudo chmod -R 755 /var/www/skillklan/public
          
          # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Nginx ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
          echo "ğŸ”„ Restarting Nginx container..."
          docker-compose restart nginx
          
          # ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ
          rm /tmp/miniapp-deploy.tar.gz
          
          echo "âœ… MiniApp deployment completed successfully!"
        EOF
        
        echo "âœ… MiniApp deployment completed!"

  deploy-full:
    name: ğŸš€ Deploy Everything (Docker)
    runs-on: ubuntu-latest
    needs: [analyze-changes, deploy-server, deploy-miniapp]
    if: needs.analyze-changes.outputs.server-changed == 'true' && needs.analyze-changes.outputs.miniapp-changed == 'true'
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: ğŸš€ Deploy everything
      run: |
        echo "ğŸš€ Starting full Docker deployment..."
        
        # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ°Ñ€Ñ…Ñ–Ğ²Ñƒ Ğ´Ğ»Ñ Ğ²ÑÑŒĞ¾Ğ³Ğ¾
        tar -czf full-deploy.tar.gz server/ miniapp/dist/ docker/ docker-compose.yml docker-*.sh
        echo "ğŸ“¦ Archive created: full-deploy.tar.gz"
        
        # Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ“¤ Uploading to server..."
        scp -o StrictHostKeyChecking=no full-deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        
        # Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ñ–
        echo "ğŸ”§ Executing deployment commands on server..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ”„ Starting full Docker deployment process..."
          cd /var/www/skillklan
          
          # Ğ¡Ñ‚Ğ¾Ğ¿ Ğ²ÑÑ–Ñ… ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          echo "â¹ï¸  Stopping all services..."
          if [ -f "docker-compose.yml" ]; then
            docker-compose down --remove-orphans || echo "âš ï¸  Docker services were not running"
          fi
          
          # Ğ—ÑƒĞ¿Ğ¸Ğ½ĞºĞ° PM2 Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ² (ÑĞºÑ‰Ğ¾ Ñ”)
          if command -v pm2 &> /dev/null; then
            pm2 stop all || echo "âš ï¸  PM2 processes were not running"
          fi
          
          # Ğ—ÑƒĞ¿Ğ¸Ğ½ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ¸Ñ… ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          sudo systemctl stop nginx || echo "âš ï¸  Nginx was not running"
          sudo systemctl stop postgresql || echo "âš ï¸  PostgreSQL was not running"
          
          # Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ° ĞºĞ¾Ğ¿Ñ–Ñ
          if [ -d "backup" ]; then
            rm -rf backup
          fi
          mkdir backup
          
          if [ -d "server" ]; then
            echo "ğŸ’¾ Backing up server..."
            mv server backup/
          fi
          
          if [ -d "public" ]; then
            echo "ğŸ’¾ Backing up frontend..."
            mv public backup/
          fi
          
          if [ -d "docker" ]; then
            echo "ğŸ’¾ Backing up docker config..."
            mv docker backup/
          fi
          
          # Ğ Ğ¾Ğ·Ğ¿Ğ°ĞºÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ½Ğ¾Ğ²Ğ¾Ñ— Ğ²ĞµÑ€ÑÑ–Ñ—
          echo "ğŸ“¦ Extracting new version..."
          cd /tmp
          tar -xzf full-deploy.tar.gz
          mv server /var/www/skillklan/
          mv dist /var/www/skillklan/public
          mv docker /var/www/skillklan/
          mv docker-compose.yml /var/www/skillklan/
          mv docker-*.sh /var/www/skillklan/
          
          # ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
          echo "ğŸ”§ Setting up server..."
          cd /var/www/skillklan/server
          npm ci --production
          
          # ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ frontend
          echo "ğŸ”§ Setting up frontend..."
          sudo chown -R www-data:www-data /var/www/skillklan/public
          sudo chmod -R 755 /var/www/skillklan/public
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞº Docker ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          echo "ğŸš€ Starting Docker services..."
          cd /var/www/skillklan
          chmod +x docker-*.sh
          ./docker-deploy.sh deploy
          
          # ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ
          rm /tmp/full-deploy.tar.gz
          
          echo "âœ… Full Docker deployment completed successfully!"
        EOF
        
        echo "âœ… Full Docker deployment completed!"
    
    - name: ğŸ” Health checks
      run: |
        echo "ğŸ” Performing health checks..."
        
        # Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºĞ¸ ÑĞµÑ€Ğ²Ñ–ÑĞ¸ Ğ·Ğ°Ğ¿ÑƒÑÑ‚ÑÑ‚ÑŒÑÑ
        echo "â³ Waiting for services to start..."
        sleep 45
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ¥ Checking server health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/api/health; then
          echo "âœ… Server is healthy"
        else
          echo "âŒ Server health check failed"
          exit 1
        fi
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ frontend
        echo "ğŸ¥ Checking frontend health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/; then
          echo "âœ… Frontend is healthy"
        else
          echo "âŒ Frontend health check failed"
          exit 1
        fi
    
    - name: ğŸ“§ Deployment summary
      run: |
        echo "ğŸ‰ Full Docker deployment completed successfully!"
        echo "   Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "   Server: ${{ secrets.SERVER_HOST }}"
        echo "   Timestamp: $(date -u)"
        echo "   Commit: ${{ github.sha }}"
        echo "   Type: Full Docker deployment (server + frontend)"

  deployment-summary:
    name: ğŸ“Š Deployment Summary
    needs: [analyze-changes, deploy-server, deploy-miniapp, deploy-full]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“Š Summary
      run: |
        echo "ğŸ¯ DEPLOYMENT SUMMARY"
        echo "===================="
        echo ""
        
        if [ "${{ needs.analyze-changes.outputs.server-changed }}" == "true" ]; then
          echo "âœ… Server changes detected and deployed"
        else
          echo "â„¹ï¸  No server changes detected"
        fi
        
        if [ "${{ needs.analyze-changes.outputs.miniapp-changed }}" == "true" ]; then
          echo "âœ… MiniApp changes detected and deployed"
        else
          echo "â„¹ï¸  No MiniApp changes detected"
        fi
        
        if [ "${{ needs.analyze-changes.outputs.config-changed }}" == "true" ]; then
          echo "âœ… Configuration changes detected"
        else
          echo "â„¹ï¸  No configuration changes detected"
        fi
        
        echo ""
        echo "ğŸš€ Deployment completed using Docker containers!"
        echo "ğŸ³ All services now running in Docker"
        echo "ğŸ“Š Check server status: docker-compose ps"
