name: ğŸ›ï¸ Manual Deploy & Rollback

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
        - deploy
        - rollback
        - health-check
        - server-status
      environment:
        description: 'Environment to work with'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      target_commit:
        description: 'Commit hash to deploy/rollback to (optional)'
        required: false
        type: string
      force:
        description: 'Force action even if checks fail'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  manual-deploy:
    name: ğŸš€ Manual Deploy
    if: github.event.inputs.action == 'deploy'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
        ref: ${{ github.event.inputs.target_commit || 'main' }}
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          server/package-lock.json
          miniapp/package-lock.json
    
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        
        echo "ğŸ”§ Installing server dependencies..."
        cd server
        npm ci --production
        
        echo "ğŸ”§ Installing MiniApp dependencies..."
        cd ../miniapp
        npm ci
    
    - name: ğŸ—ï¸ Build miniapp
      run: |
        echo "ğŸ—ï¸ Building MiniApp..."
        cd miniapp
        
        # Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ° Ğ´Ğ»Ñ Ğ·Ğ±Ñ–Ñ€ĞºĞ¸
        if [ "${{ github.event.inputs.environment }}" = "production" ]; then
          export VITE_API_URL="${{ secrets.API_URL_PRODUCTION }}"
        else
          export VITE_API_URL="${{ secrets.API_URL_STAGING }}"
        fi
        export VITE_ENVIRONMENT="${{ github.event.inputs.environment }}"
        
        echo "ğŸ”§ Build environment:"
        echo "   API URL: $VITE_API_URL"
        echo "   Environment: $VITE_ENVIRONMENT"
        echo "   Target Commit: ${{ github.event.inputs.target_commit || 'main' }}"
        
        npm run build
        
        echo "âœ… Build completed successfully"
    
    - name: ğŸš€ Deploy to server
      run: |
        echo "ğŸš€ Starting manual deployment..."
        
        # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ°Ñ€Ñ…Ñ–Ğ²Ñƒ Ğ´Ğ»Ñ Ğ²ÑÑŒĞ¾Ğ³Ğ¾
        tar -czf manual-deploy.tar.gz server/ miniapp/dist/
        echo "ğŸ“¦ Archive created: manual-deploy.tar.gz"
        
        # Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ“¤ Uploading to server..."
        scp -o StrictHostKeyChecking=no manual-deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        
        # Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ñ–
        echo "ğŸ”§ Executing deployment commands on server..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ”„ Starting manual deployment process..."
          cd /var/www/skillklan
          
          # Ğ¡Ñ‚Ğ¾Ğ¿ ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          echo "â¹ï¸  Stopping services..."
          pm2 stop skillklan-server || echo "âš ï¸  Server was not running"
          sudo systemctl stop nginx
          
          # Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ° ĞºĞ¾Ğ¿Ñ–Ñ
          if [ -d "backup" ]; then
            rm -rf backup
          fi
          mkdir backup
          
          if [ -d "server" ]; then
            echo "ğŸ’¾ Backing up server..."
            mv server backup/
          fi
          
          if [ -d "public" ]; then
            echo "ğŸ’¾ Backing up frontend..."
            mv public backup/
          fi
          
          # Ğ Ğ¾Ğ·Ğ¿Ğ°ĞºÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ½Ğ¾Ğ²Ğ¾Ñ— Ğ²ĞµÑ€ÑÑ–Ñ—
          echo "ğŸ“¦ Extracting new version..."
          cd /tmp
          tar -xzf manual-deploy.tar.gz
          mv server /var/www/skillklan/
          mv dist /var/www/skillklan/public
          
          # ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
          echo "ğŸ”§ Setting up server..."
          cd /var/www/skillklan/server
          npm ci --production
          pm2 start ecosystem.config.js --env ${{ github.event.inputs.environment }}
          pm2 save
          
          # ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ frontend
          echo "ğŸ”§ Setting up frontend..."
          sudo chown -R www-data:www-data /var/www/skillklan/public
          sudo chmod -R 755 /var/www/skillklan/public
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞº Nginx
          echo "ğŸš€ Starting Nginx..."
          sudo systemctl start nginx
          
          # ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ
          rm /tmp/manual-deploy.tar.gz
          
          echo "âœ… Manual deployment completed successfully!"
        EOF
        
        echo "âœ… Manual deployment completed!"
    
    - name: ğŸ” Health checks
      run: |
        echo "ğŸ” Performing health checks..."
        
        # Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºĞ¸ ÑĞµÑ€Ğ²Ñ–ÑĞ¸ Ğ·Ğ°Ğ¿ÑƒÑÑ‚ÑÑ‚ÑŒÑÑ
        echo "â³ Waiting for services to start..."
        sleep 25
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ¥ Checking server health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/api/health; then
          echo "âœ… Server is healthy"
        else
          echo "âŒ Server health check failed"
          if [ "${{ github.event.inputs.force }}" = "false" ]; then
            exit 1
          fi
        fi
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ frontend
        echo "ğŸ¥ Checking frontend health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/; then
          echo "âœ… Frontend is healthy"
        else
          echo "âŒ Frontend health check failed"
          if [ "${{ github.event.inputs.force }}" = "false" ]; then
            exit 1
          fi
        fi
    
    - name: ğŸ“§ Deployment summary
      run: |
        echo "ğŸ‰ Manual deployment completed successfully!"
        echo "   Environment: ${{ github.event.inputs.environment }}"
        echo "   Server: ${{ secrets.SERVER_HOST }}"
        echo "   Target Commit: ${{ github.event.inputs.target_commit || 'main' }}"
        echo "   Timestamp: $(date -u)"
        echo "   Type: Manual deployment"

  rollback:
    name: ğŸ”„ Rollback
    if: github.event.inputs.action == 'rollback'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: ğŸš€ Rollback on server
      run: |
        echo "ğŸ”„ Starting rollback process..."
        
        # Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ñ–
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ”„ Starting rollback process..."
          cd /var/www/skillklan
          
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°ÑĞ²Ğ½Ñ–ÑÑ‚ÑŒ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¸Ñ… ĞºĞ¾Ğ¿Ñ–Ğ¹
          if [ ! -d "backup" ]; then
            echo "âŒ No backup directory found"
            exit 1
          fi
          
          echo "ğŸ“‹ Available backups:"
          ls -la backup/
          
          # Ğ¡Ñ‚Ğ¾Ğ¿ ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          echo "â¹ï¸  Stopping services..."
          pm2 stop skillklan-server || echo "âš ï¸  Server was not running"
          sudo systemctl stop nginx
          
          # Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ Ñ‰Ğ¾ Ğ²Ñ–Ğ´ĞºĞ°Ñ‚ÑƒĞ²Ğ°Ñ‚Ğ¸
          if [ -d "backup/server" ]; then
            echo "ğŸ”„ Rolling back server..."
            if [ -d "server" ]; then
              rm -rf server
            fi
            mv backup/server ./
          fi
          
          if [ -d "backup/public" ]; then
            echo "ğŸ”„ Rolling back frontend..."
            if [ -d "public" ]; then
              rm -rf public
            fi
            mv backup/public ./
          fi
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          if [ -d "server" ]; then
            echo "ğŸš€ Starting server..."
            cd server
            pm2 start ecosystem.config.js --env ${{ github.event.inputs.environment }}
            pm2 save
            cd ..
          fi
          
          if [ -d "public" ]; then
            echo "ğŸš€ Starting Nginx..."
            sudo systemctl start nginx
          fi
          
          # ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ
          rm -rf backup
          
          echo "âœ… Rollback completed successfully!"
        EOF
        
        echo "âœ… Rollback completed!"
    
    - name: ğŸ” Health checks after rollback
      run: |
        echo "ğŸ” Performing health checks after rollback..."
        
        # Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºĞ¸ ÑĞµÑ€Ğ²Ñ–ÑĞ¸ Ğ·Ğ°Ğ¿ÑƒÑÑ‚ÑÑ‚ÑŒÑÑ
        echo "â³ Waiting for services to start..."
        sleep 20
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ¥ Checking server health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/api/health; then
          echo "âœ… Server is healthy after rollback"
        else
          echo "âŒ Server health check failed after rollback"
          exit 1
        fi
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ frontend
        echo "ğŸ¥ Checking frontend health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/; then
          echo "âœ… Frontend is healthy after rollback"
        else
          echo "âŒ Frontend health check failed after rollback"
          exit 1
        fi
    
    - name: ğŸ“§ Rollback summary
      run: |
        echo "ğŸ”„ Rollback completed successfully!"
        echo "   Environment: ${{ github.event.inputs.environment }}"
        echo "   Server: ${{ secrets.SERVER_HOST }}"
        echo "   Timestamp: $(date -u)"
        echo "   Type: Rollback to previous version"

  health-check:
    name: ğŸ” Health Check
    if: github.event.inputs.action == 'health-check'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: ğŸ” Check server health
      run: |
        echo "ğŸ” Performing comprehensive health check..."
        
        echo "ğŸ¥ Checking server health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/api/health; then
          echo "âœ… Server is healthy"
        else
          echo "âŒ Server health check failed"
          exit 1
        fi
        
        echo "ğŸ¥ Checking frontend health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/; then
          echo "âœ… Frontend is healthy"
        else
          echo "âŒ Frontend health check failed"
          exit 1
        fi
        
        echo "ğŸ¥ Checking Nginx status..."
        if curl -f http://${{ secrets.SERVER_HOST }}/health; then
          echo "âœ… Nginx is healthy"
        else
          echo "âŒ Nginx health check failed"
          exit 1
        fi
        
        echo "ğŸ‰ All health checks passed!"
    
    - name: ğŸ“§ Health check summary
      run: |
        echo "ğŸ” Health check completed successfully!"
        echo "   Environment: ${{ github.event.inputs.environment }}"
        echo "   Server: ${{ secrets.SERVER_HOST }}"
        echo "   Timestamp: $(date -u)"
        echo "   Status: HEALTHY"

  server-status:
    name: ğŸ“Š Server Status
    if: github.event.inputs.action == 'server-status'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: ğŸ“Š Get server status
      run: |
        echo "ğŸ“Š Getting server status..."
        
        # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "ğŸ–¥ï¸  Server Status Report"
          echo "========================"
          echo "Timestamp: $(date)"
          echo "Uptime: $(uptime)"
          echo ""
          
          echo "ğŸ’¾ Disk Usage:"
          df -h
          echo ""
          
          echo "ğŸ§  Memory Usage:"
          free -h
          echo ""
          
          echo "ğŸ”¥ PM2 Status:"
          pm2 list
          echo ""
          
          echo "ğŸŒ Nginx Status:"
          sudo systemctl status nginx --no-pager -l
          echo ""
          
          echo "ğŸ—„ï¸  PostgreSQL Status:"
          sudo systemctl status postgresql --no-pager -l
          echo ""
          
          echo "ğŸ“ Application Directory:"
          ls -la /var/www/skillklan/
          echo ""
          
          echo "ğŸ“Š Recent Logs (last 10 lines):"
          echo "Server logs:"
          tail -10 /var/www/skillklan/server/logs/server.log 2>/dev/null || echo "No server logs found"
          echo ""
          echo "Nginx logs:"
          sudo tail -10 /var/log/nginx/skillklan_access.log 2>/dev/null || echo "No Nginx logs found"
        EOF
    
    - name: ğŸ“§ Status summary
      run: |
        echo "ğŸ“Š Server status check completed!"
        echo "   Environment: ${{ github.event.inputs.environment }}"
        echo "   Server: ${{ secrets.SERVER_HOST }}"
        echo "   Timestamp: $(date -u)"
        echo "   Type: Status report"

  action-summary:
    name: ğŸ“‹ Action Summary
    needs: [manual-deploy, rollback, health-check, server-status]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“‹ Generate action summary
      run: |
        echo "ğŸ›ï¸  Manual Action Summary"
        echo "========================="
        echo "Repository: ${{ github.repository }}"
        echo "Action: ${{ github.event.inputs.action }}"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Target Commit: ${{ github.event.inputs.target_commit || 'N/A' }}"
        echo "Force: ${{ github.event.inputs.force }}"
        echo "Timestamp: $(date -u)"
        echo ""
        
        echo "ğŸ“Š Action Results:"
        if [ "${{ github.event.inputs.action }}" = "deploy" ]; then
          echo "   Manual Deploy: ${{ needs.manual-deploy.result }}"
        elif [ "${{ github.event.inputs.action }}" = "rollback" ]; then
          echo "   Rollback: ${{ needs.rollback.result }}"
        elif [ "${{ github.event.inputs.action }}" = "health-check" ]; then
          echo "   Health Check: ${{ needs.health-check.result }}"
        elif [ "${{ github.event.inputs.action }}" = "server-status" ]; then
          echo "   Server Status: ${{ needs.server-status.result }}"
        fi
        
        echo ""
        echo "ğŸ”— View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
