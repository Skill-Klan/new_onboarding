name: ğŸ§ª Test and Validate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'

jobs:
  lint-and-format:
    name: ğŸ” Lint and Format
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          server/package-lock.json
          miniapp/package-lock.json
    
    - name: ğŸ“¦ Install server dependencies
      run: |
        echo "ğŸ“¦ Installing server dependencies..."
        cd server
        npm ci
    
    - name: ğŸ“¦ Install miniapp dependencies
      run: |
        echo "ğŸ“¦ Installing MiniApp dependencies..."
        cd miniapp
        npm ci
    
    - name: ğŸ” Lint server code
      run: |
        echo "ğŸ” Linting server code..."
        cd server
        if npm run lint; then
          echo "âœ… Server linting passed"
        else
          echo "âš ï¸  No linting configured for server"
        fi
    
    - name: ğŸ” Lint miniapp code
      run: |
        echo "ğŸ” Linting MiniApp code..."
        cd miniapp
        if npm run lint; then
          echo "âœ… MiniApp linting passed"
        else
          echo "âš ï¸  No linting configured for MiniApp"
        fi
    
    - name: ğŸ¨ Check code formatting
      run: |
        echo "ğŸ¨ Checking code formatting..."
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ĞºĞ¾Ğ´Ñƒ
        if command -v prettier &> /dev/null; then
          echo "ğŸ” Checking with Prettier..."
          npx prettier --check "**/*.{js,ts,vue,json,md}" || exit 1
          echo "âœ… Code formatting is correct"
        else
          echo "âš ï¸  Prettier not available, skipping format check"
        fi

  test-server:
    name: ğŸ§ª Test Server
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: server/package-lock.json
    
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ“¦ Installing server dependencies..."
        cd server
        npm ci
    
    - name: ğŸ§ª Run unit tests
      run: |
        echo "ğŸ§ª Running server unit tests..."
        cd server
        if npm run test:unit; then
          echo "âœ… Unit tests passed"
        else
          echo "âš ï¸  No unit tests configured"
        fi
    
    - name: ğŸ§ª Run integration tests
      run: |
        echo "ğŸ§ª Running server integration tests..."
        cd server
        if npm run test:integration; then
          echo "âœ… Integration tests passed"
        else
          echo "âš ï¸  No integration tests configured"
        fi
    
    - name: ğŸ§ª Run all tests
      run: |
        echo "ğŸ§ª Running all server tests..."
        cd server
        if npm test; then
          echo "âœ… All tests passed"
        else
          echo "âŒ Tests failed"
          exit 1
        fi

  test-miniapp:
    name: ğŸ§ª Test Mini App
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: miniapp/package-lock.json
    
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ“¦ Installing MiniApp dependencies..."
        cd miniapp
        npm ci
    
    - name: ğŸ§ª Run unit tests
      run: |
        echo "ğŸ§ª Running MiniApp unit tests..."
        cd miniapp
        if npm run test:unit; then
          echo "âœ… Unit tests passed"
        else
          echo "âš ï¸  No unit tests configured"
        fi
    
    - name: ğŸ§ª Run component tests
      run: |
        echo "ğŸ§ª Running MiniApp component tests..."
        cd miniapp
        if npm run test:components; then
          echo "âœ… Component tests passed"
        else
          echo "âš ï¸  No component tests configured"
        fi
    
    - name: ğŸ§ª Run all tests
      run: |
        echo "ğŸ§ª Running all MiniApp tests..."
        cd miniapp
        if npm test; then
          echo "âœ… All tests passed"
        else
          echo "âš ï¸  No tests configured or tests failed"
        fi

  build-check:
    name: ğŸ—ï¸ Build Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          server/package-lock.json
          miniapp/package-lock.json
    
    - name: ğŸ“¦ Install server dependencies
      run: |
        echo "ğŸ“¦ Installing server dependencies..."
        cd server
        npm ci --production
    
    - name: ğŸ“¦ Install miniapp dependencies
      run: |
        echo "ğŸ“¦ Installing MiniApp dependencies..."
        cd miniapp
        npm ci
    
    - name: ğŸ—ï¸ Build miniapp
      run: |
        echo "ğŸ—ï¸ Building MiniApp..."
        cd miniapp
        
        # Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ° Ğ´Ğ»Ñ Ğ·Ğ±Ñ–Ñ€ĞºĞ¸
        export VITE_API_URL="http://localhost:3000/api"
        export VITE_ENVIRONMENT="test"
        
        echo "ğŸ”§ Build environment:"
        echo "   API URL: $VITE_API_URL"
        echo "   Environment: $VITE_ENVIRONMENT"
        
        npm run build
        
        echo "âœ… Build completed successfully"
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ‰Ğ¾ Ğ·Ğ±Ñ–Ñ€ĞºĞ° ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ğ»Ğ° Ğ½ĞµĞ¾Ğ±Ñ…Ñ–Ğ´Ğ½Ñ– Ñ„Ğ°Ğ¹Ğ»Ğ¸
        if [ -d "dist" ] && [ -f "dist/index.html" ]; then
          echo "âœ… Build artifacts verified"
        else
          echo "âŒ Build artifacts missing"
          exit 1
        fi
    
    - name: ğŸ” Check build artifacts
      run: |
        echo "ğŸ” Checking build artifacts..."
        cd miniapp/dist
        
        echo "ğŸ“ Build directory contents:"
        ls -la
        
        echo "ğŸ“„ Checking index.html..."
        if [ -f "index.html" ]; then
          echo "âœ… index.html found"
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ‰Ğ¾ HTML Ğ¼Ñ–ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ½ĞµĞ¾Ğ±Ñ…Ñ–Ğ´Ğ½Ñ– ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¸
          if grep -q "app" index.html; then
            echo "âœ… index.html contains app element"
          else
            echo "âš ï¸  index.html may be incomplete"
          fi
        else
          echo "âŒ index.html missing"
          exit 1
        fi
        
        echo "ğŸ“¦ Checking assets..."
        if [ -d "assets" ]; then
          echo "âœ… assets directory found"
          echo "   Assets count: $(find assets -type f | wc -l)"
        else
          echo "âš ï¸  assets directory missing"
        fi

  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          server/package-lock.json
          miniapp/package-lock.json
    
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies for security check..."
        cd server && npm ci
        cd ../miniapp && npm ci
    
    - name: ğŸ”’ Run npm audit
      run: |
        echo "ğŸ”’ Running security audit..."
        
        echo "ğŸ” Checking server dependencies..."
        cd server
        npm audit --audit-level moderate || echo "âš ï¸  Security vulnerabilities found in server"
        
        echo "ğŸ” Checking MiniApp dependencies..."
        cd ../miniapp
        npm audit --audit-level moderate || echo "âš ï¸  Security vulnerabilities found in MiniApp"
    
    - name: ğŸ”’ Check for secrets
      run: |
        echo "ğŸ”’ Checking for exposed secrets..."
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°ÑĞ²Ğ½Ñ–ÑÑ‚ÑŒ Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ñ–Ğ¹Ğ½Ğ¸Ñ… ÑĞµĞºÑ€ĞµÑ‚Ñ–Ğ²
        if grep -r "password\|secret\|token\|key" . --exclude-dir=node_modules --exclude-dir=.git | grep -v "config.env\|.env.example"; then
          echo "âš ï¸  Potential secrets found in code"
          grep -r "password\|secret\|token\|key" . --exclude-dir=node_modules --exclude-dir=.git | grep -v "config.env\|.env.example"
        else
          echo "âœ… No obvious secrets found in code"
        fi

  test-summary:
    name: ğŸ“Š Test Summary
    needs: [lint-and-format, test-server, test-miniapp, build-check, security-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“‹ Generate test summary
      run: |
        echo "ğŸ§ª Test and Validation Summary"
        echo "=============================="
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "Timestamp: $(date -u)"
        echo ""
        
        echo "ğŸ“Š Test Results:"
        echo "   Lint and Format: ${{ needs.lint-and-format.result }}"
        echo "   Server Tests: ${{ needs.test-server.result }}"
        echo "   MiniApp Tests: ${{ needs.test-miniapp.result }}"
        echo "   Build Check: ${{ needs.build-check.result }}"
        echo "   Security Check: ${{ needs.security-check.result }}"
        echo ""
        
        # Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ Ğ·Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
        if [ "${{ needs.lint-and-format.result }}" = "success" ] && \
           [ "${{ needs.test-server.result }}" = "success" ] && \
           [ "${{ needs.test-miniapp.result }}" = "success" ] && \
           [ "${{ needs.build-check.result }}" = "success" ] && \
           [ "${{ needs.security-check.result }}" = "success" ]; then
          echo "ğŸ‰ All checks passed! Code is ready for deployment."
          echo "âœ… Status: READY"
        else
          echo "âŒ Some checks failed. Please fix issues before deployment."
          echo "âŒ Status: NOT READY"
        fi
        
        echo ""
        echo "ğŸ”— View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
