name: ğŸš€ Smart Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      force_full_deploy:
        description: 'Force full deployment'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  CACHE_DEPENDENCY_PATH: |
    server/package-lock.json
    miniapp/package-lock.json

jobs:
  analyze-changes:
    name: ğŸ” Analyze Changes
    runs-on: ubuntu-latest
    outputs:
      needs-server-deploy: ${{ steps.changes.outputs.server }}
      needs-miniapp-deploy: ${{ steps.changes.outputs.miniapp }}
      needs-full-deploy: ${{ steps.changes.outputs.full }}
      deployment-type: ${{ steps.changes.outputs.type }}
      change-summary: ${{ steps.changes.outputs.summary }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: ğŸ” Analyze changes
      id: changes
      run: |
        echo "ğŸ” Analyzing changes between commits..."
        
        # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½ĞµĞ½Ğ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ²
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # Ğ”Ğ»Ñ PR - Ğ¿Ğ¾Ñ€Ñ–Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ· Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ñ Ğ³Ñ–Ğ»ĞºĞ¾Ñ
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
        else
          # Ğ”Ğ»Ñ push - Ğ¿Ğ¾Ñ€Ñ–Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ· Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½Ñ–Ğ¼ ĞºĞ¾Ğ¼Ñ–Ñ‚Ğ¾Ğ¼
          CHANGED_FILES=$(git diff --name-only HEAD~1...HEAD)
        fi
        
        echo "ğŸ“‹ Changed files:"
        echo "$CHANGED_FILES"
        
        # ĞĞ½Ğ°Ğ»Ñ–Ğ·ÑƒÑ”Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ¸
        SERVER_CHANGES=false
        MINIAPP_CHANGES=false
        FULL_DEPLOY=false
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ğ² ÑĞµÑ€Ğ²ĞµÑ€Ñ–
        if echo "$CHANGED_FILES" | grep -q "^server/"; then
          SERVER_CHANGES=true
          echo "âœ… Server changes detected"
        fi
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ğ² miniapp
        if echo "$CHANGED_FILES" | grep -q "^miniapp/"; then
          MINIAPP_CHANGES=true
          echo "âœ… MiniApp changes detected"
        fi
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ¸ (Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ÑŒ Ğ¿Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ)
        if echo "$CHANGED_FILES" | grep -q "^shared/"; then
          FULL_DEPLOY=true
          echo "âš ï¸  Shared code changes detected - full deploy required"
        fi
        
        if echo "$CHANGED_FILES" | grep -q "package.json"; then
          FULL_DEPLOY=true
          echo "âš ï¸  Dependencies changed - full deploy required"
        fi
        
        if echo "$CHANGED_FILES" | grep -q "docker-compose.yml"; then
          FULL_DEPLOY=true
          echo "âš ï¸  Infrastructure changed - full deploy required"
        fi
        
        # Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ Ñ‚Ğ¸Ğ¿ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
        if [ "$FULL_DEPLOY" = true ]; then
          DEPLOY_TYPE="full"
        elif [ "$SERVER_CHANGES" = true ] && [ "$MINIAPP_CHANGES" = true ]; then
          DEPLOY_TYPE="both"
        elif [ "$SERVER_CHANGES" = true ]; then
          DEPLOY_TYPE="server"
        elif [ "$MINIAPP_CHANGES" = true ]; then
          DEPLOY_TYPE="miniapp"
        else
          DEPLOY_TYPE="none"
        fi
        
        # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ½Ñ Ğ·Ğ¼Ñ–Ğ½
        CHANGE_SUMMARY=""
        if [ "$SERVER_CHANGES" = true ]; then
          CHANGE_SUMMARY="$CHANGE_SUMMARY Server,"
        fi
        if [ "$MINIAPP_CHANGES" = true ]; then
          CHANGE_SUMMARY="$CHANGE_SUMMARY MiniApp,"
        fi
        if [ "$FULL_DEPLOY" = true ]; then
          CHANGE_SUMMARY="$CHANGE_SUMMARY Full Deploy Required,"
        fi
        
        # Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ¹Ğ²Ñƒ ĞºĞ¾Ğ¼Ñƒ
        CHANGE_SUMMARY=$(echo "$CHANGE_SUMMARY" | sed 's/,$//')
        
        # Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ outputs
        echo "server=$SERVER_CHANGES" >> $GITHUB_OUTPUT
        echo "miniapp=$MINIAPP_CHANGES" >> $GITHUB_OUTPUT
        echo "full=$FULL_DEPLOY" >> $GITHUB_OUTPUT
        echo "type=$DEPLOY_TYPE" >> $GITHUB_OUTPUT
        echo "summary=$CHANGE_SUMMARY" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š Deployment analysis complete:"
        echo "   Type: $DEPLOY_TYPE"
        echo "   Summary: $CHANGE_SUMMARY"
        echo "   Server: $SERVER_CHANGES"
        echo "   MiniApp: $MINIAPP_CHANGES"
        echo "   Full Deploy: $FULL_DEPLOY"

  deploy-server:
    name: ğŸ–¥ï¸ Deploy Server
    needs: analyze-changes
    if: |
      (needs.server-deploy == 'true' && needs.full-deploy != 'true') ||
      (github.event.inputs.force_full_deploy == 'true')
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: server/package-lock.json
    
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ“¦ Installing server dependencies..."
        cd server
        npm ci --production
        echo "âœ… Dependencies installed successfully"
    
    - name: ğŸ§ª Run tests
      run: |
        echo "ğŸ§ª Running server tests..."
        cd server
        if npm run test; then
          echo "âœ… Tests passed"
        else
          echo "âŒ Tests failed"
          exit 1
        fi
    
    - name: ğŸš€ Deploy to server
      run: |
        echo "ğŸš€ Starting server deployment..."
        
        # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ°Ñ€Ñ…Ñ–Ğ²Ñƒ Ğ´Ğ»Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
        tar -czf server-deploy.tar.gz server/
        echo "ğŸ“¦ Archive created: server-deploy.tar.gz"
        
        # Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ“¤ Uploading to server..."
        scp -o StrictHostKeyChecking=no server-deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        
        # Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ñ–
        echo "ğŸ”§ Executing deployment commands on server..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ”„ Starting server deployment process..."
          cd /var/www/skillklan
          
          # Ğ¡Ñ‚Ğ¾Ğ¿ Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
          echo "â¹ï¸  Stopping current server..."
          pm2 stop skillklan-server || echo "âš ï¸  Server was not running"
          
          # Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ° ĞºĞ¾Ğ¿Ñ–Ñ
          if [ -d "server" ]; then
            BACKUP_DIR="server.backup.$(date +%Y%m%d_%H%M%S)"
            echo "ğŸ’¾ Creating backup: $BACKUP_DIR"
            mv server "$BACKUP_DIR"
          fi
          
          # Ğ Ğ¾Ğ·Ğ¿Ğ°ĞºÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ½Ğ¾Ğ²Ğ¾Ñ— Ğ²ĞµÑ€ÑÑ–Ñ—
          echo "ğŸ“¦ Extracting new version..."
          cd /tmp
          tar -xzf server-deploy.tar.gz
          mv server /var/www/skillklan/
          
          # Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹
          echo "ğŸ“¥ Installing dependencies..."
          cd /var/www/skillklan/server
          npm ci --production
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
          echo "ğŸš€ Starting server..."
          pm2 start ecosystem.config.js --env ${{ github.event.inputs.environment || 'staging' }}
          pm2 save
          
          # ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ
          rm /tmp/server-deploy.tar.gz
          
          echo "âœ… Server deployment completed successfully!"
        EOF
        
        echo "âœ… Server deployment completed!"
    
    - name: ğŸ” Health check
      run: |
        echo "ğŸ” Performing health check..."
        
        # Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºĞ¸ ÑĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒÑÑ
        echo "â³ Waiting for server to start..."
        sleep 15
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑ
        echo "ğŸ¥ Checking server health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/api/health; then
          echo "âœ… Server is healthy and responding"
        else
          echo "âŒ Server health check failed"
          exit 1
        fi
    
    - name: ğŸ“§ Deployment summary
      run: |
        echo "ğŸ‰ Server deployment completed successfully!"
        echo "   Environment: ${{ github.event.inputs.environment || 'staging' }}"
        echo "   Server: ${{ secrets.SERVER_HOST }}"
        echo "   Timestamp: $(date -u)"
        echo "   Commit: ${{ github.sha }}"

  deploy-miniapp:
    name: ğŸ“± Deploy Mini App
    needs: analyze-changes
    if: |
      (needs.miniapp-deploy == 'true' && needs.full-deploy != 'true') ||
      (github.event.inputs.force_full_deploy == 'true')
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: miniapp/package-lock.json
    
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ“¦ Installing MiniApp dependencies..."
        cd miniapp
        npm ci
        echo "âœ… Dependencies installed successfully"
    
    - name: ğŸ§ª Run tests
      run: |
        echo "ğŸ§ª Running MiniApp tests..."
        cd miniapp
        if npm run test:unit; then
          echo "âœ… Tests passed"
        else
          echo "âš ï¸  No tests configured, skipping..."
        fi
    
    - name: ğŸ—ï¸ Build for production
      run: |
        echo "ğŸ—ï¸ Building MiniApp for production..."
        cd miniapp
        
        # Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ° Ğ´Ğ»Ñ Ğ·Ğ±Ñ–Ñ€ĞºĞ¸
        export VITE_API_URL="${{ secrets.API_URL_STAGING }}"
        export VITE_ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
        
        echo "ğŸ”§ Build environment:"
        echo "   API URL: $VITE_API_URL"
        echo "   Environment: $VITE_ENVIRONMENT"
        
        npm run build
        
        echo "âœ… Build completed successfully"
    
    - name: ğŸš€ Deploy to server
      run: |
        echo "ğŸš€ Starting MiniApp deployment..."
        
        # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ°Ñ€Ñ…Ñ–Ğ²Ñƒ Ğ´Ğ»Ñ frontend
        tar -czf miniapp-deploy.tar.gz miniapp/dist/
        echo "ğŸ“¦ Archive created: miniapp-deploy.tar.gz"
        
        # Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ“¤ Uploading to server..."
        scp -o StrictHostKeyChecking=no miniapp-deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        
        # Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ñ–
        echo "ğŸ”§ Executing deployment commands on server..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ”„ Starting MiniApp deployment process..."
          cd /var/www/skillklan
          
          # Ğ¡Ñ‚Ğ¾Ğ¿ Nginx
          echo "â¹ï¸  Stopping Nginx..."
          sudo systemctl stop nginx
          
          # Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ° ĞºĞ¾Ğ¿Ñ–Ñ Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ñ— Ğ²ĞµÑ€ÑÑ–Ñ—
          if [ -d "public" ]; then
            BACKUP_DIR="public.backup.$(date +%Y%m%d_%H%M%S)"
            echo "ğŸ’¾ Creating backup: $BACKUP_DIR"
            mv public "$BACKUP_DIR"
          fi
          
          # Ğ Ğ¾Ğ·Ğ¿Ğ°ĞºÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ½Ğ¾Ğ²Ğ¾Ñ— Ğ²ĞµÑ€ÑÑ–Ñ—
          echo "ğŸ“¦ Extracting new version..."
          cd /tmp
          tar -xzf miniapp-deploy.tar.gz
          mv dist /var/www/skillklan/public
          
          # ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¿Ñ€Ğ°Ğ²
          echo "ğŸ” Setting permissions..."
          sudo chown -R www-data:www-data /var/www/skillklan/public
          sudo chmod -R 755 /var/www/skillklan/public
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞº Nginx
          echo "ğŸš€ Starting Nginx..."
          sudo systemctl start nginx
          
          # ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ
          rm /tmp/miniapp-deploy.tar.gz
          
          echo "âœ… MiniApp deployment completed successfully!"
        EOF
        
        echo "âœ… MiniApp deployment completed!"
    
    - name: ğŸ” Frontend health check
      run: |
        echo "ğŸ” Performing frontend health check..."
        
        # Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºĞ¸ Nginx Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒÑÑ
        echo "â³ Waiting for Nginx to start..."
        sleep 10
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑ
        echo "ğŸ¥ Checking frontend health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/; then
          echo "âœ… Frontend is healthy and responding"
        else
          echo "âŒ Frontend health check failed"
          exit 1
        fi
    
    - name: ğŸ“§ Deployment summary
      run: |
        echo "ğŸ‰ MiniApp deployment completed successfully!"
        echo "   Environment: ${{ github.event.inputs.environment || 'staging' }}"
        echo "   Server: ${{ secrets.SERVER_HOST }}"
        echo "   Timestamp: $(date -u)"
        echo "   Commit: ${{ github.sha }}"

  deploy-full:
    name: ğŸŒ Full Deployment
    needs: analyze-changes
    if: |
      needs.full-deploy == 'true' ||
      github.event.inputs.force_full_deploy == 'true'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ env.CACHE_DEPENDENCY_PATH }}
    
    - name: ğŸ“¦ Install server dependencies
      run: |
        echo "ğŸ“¦ Installing server dependencies..."
        cd server
        npm ci --production
        echo "âœ… Server dependencies installed"
    
    - name: ğŸ“¦ Install miniapp dependencies
      run: |
        echo "ğŸ“¦ Installing MiniApp dependencies..."
        cd miniapp
        npm ci
        echo "âœ… MiniApp dependencies installed"
    
    - name: ğŸ§ª Run server tests
      run: |
        echo "ğŸ§ª Running server tests..."
        cd server
        if npm run test; then
          echo "âœ… Server tests passed"
        else
          echo "âŒ Server tests failed"
          exit 1
        fi
    
    - name: ğŸ§ª Run miniapp tests
      run: |
        echo "ğŸ§ª Running MiniApp tests..."
        cd miniapp
        if npm run test:unit; then
          echo "âœ… MiniApp tests passed"
        else
          echo "âš ï¸  No MiniApp tests configured, skipping..."
        fi
    
    - name: ğŸ—ï¸ Build miniapp
      run: |
        echo "ğŸ—ï¸ Building MiniApp for production..."
        cd miniapp
        
        # Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ° Ğ´Ğ»Ñ Ğ·Ğ±Ñ–Ñ€ĞºĞ¸
        export VITE_API_URL="${{ secrets.API_URL_PRODUCTION }}"
        export VITE_ENVIRONMENT="${{ github.event.inputs.environment || 'production' }}"
        
        echo "ğŸ”§ Build environment:"
        echo "   API URL: $VITE_API_URL"
        echo "   Environment: $VITE_ENVIRONMENT"
        
        npm run build
        
        echo "âœ… Build completed successfully"
    
    - name: ğŸš€ Deploy everything
      run: |
        echo "ğŸš€ Starting full deployment..."
        
        # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ°Ñ€Ñ…Ñ–Ğ²Ñƒ Ğ´Ğ»Ñ Ğ²ÑÑŒĞ¾Ğ³Ğ¾
        tar -czf full-deploy.tar.gz server/ miniapp/dist/
        echo "ğŸ“¦ Archive created: full-deploy.tar.gz"
        
        # Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ“¤ Uploading to server..."
        scp -o StrictHostKeyChecking=no full-deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        
        # Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ñ–
        echo "ğŸ”§ Executing deployment commands on server..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ”„ Starting full deployment process..."
          cd /var/www/skillklan
          
          # Ğ¡Ñ‚Ğ¾Ğ¿ ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²
          echo "â¹ï¸  Stopping services..."
          pm2 stop skillklan-server || echo "âš ï¸  Server was not running"
          sudo systemctl stop nginx
          
          # Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ° ĞºĞ¾Ğ¿Ñ–Ñ
          if [ -d "backup" ]; then
            rm -rf backup
          fi
          mkdir backup
          
          if [ -d "server" ]; then
            echo "ğŸ’¾ Backing up server..."
            mv server backup/
          fi
          
          if [ -d "public" ]; then
            echo "ğŸ’¾ Backing up frontend..."
            mv public backup/
          fi
          
          # Ğ Ğ¾Ğ·Ğ¿Ğ°ĞºÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ½Ğ¾Ğ²Ğ¾Ñ— Ğ²ĞµÑ€ÑÑ–Ñ—
          echo "ğŸ“¦ Extracting new version..."
          cd /tmp
          tar -xzf full-deploy.tar.gz
          mv server /var/www/skillklan/
          mv dist /var/www/skillklan/public
          
          # ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
          echo "ğŸ”§ Setting up server..."
          cd /var/www/skillklan/server
          npm ci --production
          pm2 start ecosystem.config.js --env ${{ github.event.inputs.environment || 'production' }}
          pm2 save
          
          # ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ frontend
          echo "ğŸ”§ Setting up frontend..."
          sudo chown -R www-data:www-data /var/www/skillklan/public
          sudo chmod -R 755 /var/www/skillklan/public
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞº Nginx
          echo "ğŸš€ Starting Nginx..."
          sudo systemctl start nginx
          
          # ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ
          rm /tmp/full-deploy.tar.gz
          
          echo "âœ… Full deployment completed successfully!"
        EOF
        
        echo "âœ… Full deployment completed!"
    
    - name: ğŸ” Health checks
      run: |
        echo "ğŸ” Performing health checks..."
        
        # Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºĞ¸ ÑĞµÑ€Ğ²Ñ–ÑĞ¸ Ğ·Ğ°Ğ¿ÑƒÑÑ‚ÑÑ‚ÑŒÑÑ
        echo "â³ Waiting for services to start..."
        sleep 25
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€
        echo "ğŸ¥ Checking server health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/api/health; then
          echo "âœ… Server is healthy"
        else
          echo "âŒ Server health check failed"
          exit 1
        fi
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ frontend
        echo "ğŸ¥ Checking frontend health..."
        if curl -f http://${{ secrets.SERVER_HOST }}/; then
          echo "âœ… Frontend is healthy"
        else
          echo "âŒ Frontend health check failed"
          exit 1
        fi
    
    - name: ğŸ“§ Deployment summary
      run: |
        echo "ğŸ‰ Full deployment completed successfully!"
        echo "   Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "   Server: ${{ secrets.SERVER_HOST }}"
        echo "   Timestamp: $(date -u)"
        echo "   Commit: ${{ github.sha }}"
        echo "   Type: Full deployment (server + frontend)"

  deployment-summary:
    name: ğŸ“Š Deployment Summary
    needs: [analyze-changes, deploy-server, deploy-miniapp, deploy-full]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“‹ Generate summary
      run: |
        echo "ğŸ¯ Deployment Summary"
        echo "====================="
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "Timestamp: $(date -u)"
        echo ""
        
        if [ "${{ needs.analyze-changes.outputs.deployment-type }}" = "none" ]; then
          echo "âœ… No deployment needed - no relevant changes detected"
        else
          echo "ğŸš€ Deployment Type: ${{ needs.analyze-changes.outputs.deployment-type }}"
          echo "ğŸ“‹ Changes: ${{ needs.analyze-changes.outputs.change-summary }}"
          echo ""
          
          if [ "${{ needs.deploy-server.result }}" = "success" ]; then
            echo "âœ… Server deployment: SUCCESS"
          elif [ "${{ needs.deploy-server.result }}" = "skipped" ]; then
            echo "â­ï¸  Server deployment: SKIPPED"
          else
            echo "âŒ Server deployment: FAILED"
          fi
          
          if [ "${{ needs.deploy-miniapp.result }}" = "success" ]; then
            echo "âœ… MiniApp deployment: SUCCESS"
          elif [ "${{ needs.deploy-miniapp.result }}" = "skipped" ]; then
            echo "â­ï¸  MiniApp deployment: SKIPPED"
          else
            echo "âŒ MiniApp deployment: FAILED"
          fi
          
          if [ "${{ needs.deploy-full.result }}" = "success" ]; then
            echo "âœ… Full deployment: SUCCESS"
          elif [ "${{ needs.deploy-full.result }}" = "skipped" ]; then
            echo "â­ï¸  Full deployment: SKIPPED"
          else
            echo "âŒ Full deployment: FAILED"
          fi
        fi
        
        echo ""
        echo "ğŸ”— View deployment: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
